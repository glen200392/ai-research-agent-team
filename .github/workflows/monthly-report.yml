name: Monthly AI Research Report

# ── Triggers ──────────────────────────────────────────────────────────────────
on:
  # Automatic: 1st of every month at 2:00 AM UTC
  schedule:
    - cron: '0 2 1 * *'

  # Manual: choose month and which teams to run
  workflow_dispatch:
    inputs:
      month:
        description: 'Target month (YYYY-MM or "auto" = previous month)'
        default: 'auto'
        required: false
      teams:
        description: 'Which teams to run'
        default: 'all'
        required: false
        type: choice
        options:
          - all
          - team-a
          - team-b
          - team-c

# ── Global env — injected into every step ─────────────────────────────────────
env:
  ANTHROPIC_API_KEY:    ${{ secrets.ANTHROPIC_API_KEY }}
  OPENAI_API_KEY:       ${{ secrets.OPENAI_API_KEY }}
  GOOGLE_API_KEY:       ${{ secrets.GOOGLE_API_KEY }}
  TAVILY_API_KEY:       ${{ secrets.TAVILY_API_KEY }}
  SERPER_API_KEY:       ${{ secrets.SERPER_API_KEY }}
  BRAVE_SEARCH_API_KEY: ${{ secrets.BRAVE_SEARCH_API_KEY }}
  # Leave empty → system auto-detects from keys above
  DEFAULT_LLM_PROVIDER: ${{ secrets.DEFAULT_LLM_PROVIDER }}

# ── Jobs ──────────────────────────────────────────────────────────────────────
jobs:
  generate-report:
    name: Generate AI Research Report
    runs-on: ubuntu-latest
    timeout-minutes: 90

    # ── Required for git commit + push back to repo ────────────────────────
    permissions:
      contents: write

    steps:
      # ── Setup ─────────────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0      # full history needed for git push
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Detect available LLM providers
        run: python run.py detect

      # ── Team A — Monthly Intelligence Report ──────────────────────────────
      - name: Run Team A — Monthly Report
        if: >-
          inputs.teams == 'all' ||
          inputs.teams == 'team-a' ||
          github.event_name == 'schedule'
        run: |
          MONTH="${{ inputs.month }}"
          python run.py team-a --month "${MONTH:-auto}"

      # ── Team B — Evolution Chronicle ──────────────────────────────────────
      - name: Run Team B — Evolution Chronicle
        if: >-
          inputs.teams == 'all' ||
          inputs.teams == 'team-b' ||
          github.event_name == 'schedule'
        run: python run.py team-b

      # ── Team C — Pedagogy Lesson ──────────────────────────────────────────
      - name: Run Team C — Pedagogy Lesson
        if: >-
          inputs.teams == 'all' ||
          inputs.teams == 'team-c' ||
          github.event_name == 'schedule'
        run: python run.py team-c

      # ── Commit outputs back to repository ────────────────────────────────
      - name: Commit generated outputs
        run: |
          git config user.name  "AI Research Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Force-add output dirs (reports/*.md is .gitignored for local dev)
          git add -f \
            reports/ \
            docs/evolution-chronicle/ \
            pedagogy/

          MONTH=$(date +%Y-%m)
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore: automated AI research output ${MONTH} [skip ci]"
            git push
          fi

      # ── Save as downloadable artifacts ───────────────────────────────────
      - name: Upload outputs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-research-outputs-${{ github.run_number }}
          path: |
            reports/*.md
            docs/evolution-chronicle/by-period/*.md
            pedagogy/weekly-lessons/*/complete-lesson.md
          retention-days: 90
          if-no-files-found: warn

      # ── Job summary ───────────────────────────────────────────────────────
      - name: Write job summary
        if: always()
        run: |
          {
            echo "## AI Research Agent Team — Run Summary"
            echo ""
            echo "| Field | Value |"
            echo "|-------|-------|"
            echo "| Date | $(date -u '+%Y-%m-%d %H:%M UTC') |"
            echo "| Month | ${{ inputs.month != '' && inputs.month || 'auto (previous month)' }} |"
            echo "| Teams run | ${{ inputs.teams || 'all' }} |"
            echo "| Trigger | ${{ github.event_name }} |"
            echo ""
            echo "### Generated Files"
            echo "\`\`\`"
            ls -lh reports/*.md 2>/dev/null         || echo "  (no Team A reports)"
            ls -lh docs/evolution-chronicle/by-period/*.md 2>/dev/null || echo "  (no Team B period entries)"
            ls -lh pedagogy/weekly-lessons/*/complete-lesson.md 2>/dev/null || echo "  (no Team C lessons)"
            echo "\`\`\`"
          } >> "$GITHUB_STEP_SUMMARY"
